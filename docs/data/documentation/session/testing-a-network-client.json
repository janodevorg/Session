{"primaryContentSections":[{"kind":"content","content":[{"anchor":"What-to-test-in-a-network-client?","level":2,"type":"heading","text":"What to test in a network client?"},{"type":"paragraph","inlineContent":[{"type":"text","text":"A network client interacts with the world to send and receive information. Then it processes that information and outputs a result. We are interested in testing that “processing information” part, so we are going to replace the rest with test objects."}]},{"type":"paragraph","inlineContent":[{"type":"image","identifier":"networking1"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Things to test here:"}]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Resource → URLRequest"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Response → Decodable"}]}]}]},{"anchor":"Abstracting-dependencies","level":2,"type":"heading","text":"Abstracting dependencies"},{"type":"paragraph","inlineContent":[{"type":"text","text":"How to test with protocols?"}]},{"type":"orderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Replace dependencies with protocols."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Point dependencies to test objects."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Run the code under test providing known values through your test objects."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Assert the behavior of the tested code."}]}]}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Here is a network request in a typical client:"}]},{"type":"codeListing","syntax":"swift","code":["import Foundation","","let session = URLSession(configuration: URLSessionConfiguration.default)","let request = URLRequest(url: URL(string: \"https:\/\/google.com\")!)","let task: URLSessionDataTask = session.dataTask(with: request, completionHandler: { data, response, error in ","    print(response as Any) ","})","task.resume()","","RunLoop.current.run(mode: RunLoop.Mode.default, before: NSDate(timeIntervalSinceNow: 1) as Date)"]},{"type":"paragraph","inlineContent":[{"type":"image","identifier":"networking2"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"The objects that provide I\/O are URLSession and URLSessionDataTask. Let’s write protocols to replace them:"}]},{"type":"codeListing","syntax":"swift","code":["protocol Session {","    func dataTask(with request: URLRequest, completionHandler: @escaping (Data?, URLResponse?, Error?) -> Void) -> SessionDataTask","}","","protocol SessionDataTask {","    func resume()","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Once we replace the specific objects with the protocols, we will be able to provide two implementations:"}]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Apple’s URLSession, URLSessionDataTask"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Our test objects"}]}]}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"But first, we need to conform the real objects to our protocols:"}]},{"type":"codeListing","syntax":"swift","code":["extension URLSessionDataTask: SessionDataTask {}","","extension URLSession: Session {","    func dataTask(with request: URLRequest, completionHandler: @escaping (Data?, URLResponse?, Error?) -> Void) -> SessionDataTask {","        return dataTask(with: request, completionHandler: completionHandler) as URLSessionDataTask","    }","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Now our client depends on protocols, not on the original objects:"}]},{"type":"paragraph","inlineContent":[{"type":"image","identifier":"networking3"}]},{"anchor":"Usage-example","level":2,"type":"heading","text":"Usage example"},{"type":"paragraph","inlineContent":[{"type":"text","text":"If you implement an API, you probably group the network calls in a network client"},{"type":"text","text":" "},{"type":"text","text":"that uses "},{"type":"codeVoice","code":"URLSession.shared"},{"type":"text","text":". But for unit tests, you need the network to have deterministic conditions,"},{"type":"text","text":" "},{"type":"text","text":"so you have to replace that shared session with one that stubs hardcoded results."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"To switch the session for that client you need to inject the session through a init parameter. Something like this:"}]},{"type":"codeListing","syntax":"swift","code":["let client = WeatherClient(session: URLSession.shared)","client.weather(city: \"London\") { result in \/* ... *\/ }"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Now you are able to replace the session with a stubbed one in your unit tests:"}]},{"type":"codeListing","syntax":"swift","code":["let url = URL(string: \"https:\/\/example.com\")! ","let data = \"{ ... a json response ... }\".data(using: .utf8)","let sessionStub = JSONSessionStub.success(data: data, url: url)","","let client = WeatherClient(session: sessionStub)"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"The example above uses JSONSessionStub to stub a JSON response. To stub something else"},{"type":"text","text":" "},{"type":"text","text":"use the SessionStub superclass with the parameters data, response, and error that you prefer:"}]},{"type":"codeListing","syntax":"swift","code":["let data: Data? = nil","let response: URLResponse? = nil","let error: Error? = nil","let sessionStub = SessionStub(data: data, response: response, error: error)","","let client = WeatherClient(session: sessionStub)"]},{"anchor":"What-is-a-stub-anyway?","level":2,"type":"heading","text":"What is a stub anyway?"},{"type":"paragraph","inlineContent":[{"type":"text","text":"A "},{"type":"strong","inlineContent":[{"type":"text","text":"stub"}]},{"type":"text","text":" is an object without logic that simply returns fixed values."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"A stub is one kind of test double. A "},{"type":"strong","inlineContent":[{"type":"text","text":"test double"}]},{"type":"text","text":" is an object that stands for a real object in a test. The name comes from the term stunt double used in cinema. There are five kinds:"}]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Dummy"}]},{"type":"text","text":": an object that fills a space but doesn’t actually do anything."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Fake"}]},{"type":"text","text":": an object with a simple implementation. It behaves like a real object but it is not suitable for production. For example, an in-memory database in place of a real one."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Mock"}]},{"type":"text","text":": an object with expectations on how it should be called. The test fails if it is not called that way. Mocks say “I expect you to call foo() with bar, and if you don’t there’s an error”"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Spy"}]},{"type":"text","text":": an object that records the calls received and asserts those calls."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Stub"}]},{"type":"text","text":": an object without logic that simply returns fixed values."}]}]}]}]}],"schemaVersion":{"major":0,"minor":2,"patch":0},"sections":[],"variants":[{"paths":["\/documentation\/session\/testing-a-network-client"],"traits":[{"interfaceLanguage":"swift"}]}],"identifier":{"url":"doc:\/\/Session\/documentation\/Session\/Testing-a-network-client","interfaceLanguage":"swift"},"abstract":[{"type":"text","text":"No overview available."}],"kind":"article","metadata":{"roleHeading":"Article","title":"Testing a network client","role":"article","modules":[{"name":"Session"}]},"hierarchy":{"paths":[["doc:\/\/Session\/documentation\/Session"]]},"references":{"networking3":{"alt":"networking3","type":"image","identifier":"networking3","variants":[{"url":"\/images\/networking3.png","traits":["1x","light"]}]},"networking2":{"alt":"networking2","type":"image","identifier":"networking2","variants":[{"url":"\/images\/networking2.png","traits":["1x","light"]}]},"doc://Session/documentation/Session":{"role":"collection","title":"Session","abstract":[{"type":"text","text":"A Session protocol that mimics URLSession, so we can stub responses."}],"identifier":"doc:\/\/Session\/documentation\/Session","kind":"symbol","type":"topic","url":"\/documentation\/session"},"networking1":{"alt":"networking","type":"image","identifier":"networking1","variants":[{"url":"\/images\/networking1.png","traits":["1x","light"]}]}}}